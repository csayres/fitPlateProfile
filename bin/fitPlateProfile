#!/usr/bin/env python
import os
import sys
import argparse
import numpy
from telnetlib import Telnet
import glob

from fitPlateProfile import CardinalMeasurement, doNewInterp, plt, \
     DirThetaMapCard, MMPerInch, addProfilometry

MeasRadii = numpy.asarray([1.75, 3.75, 5.75, 7.75, 10.75]) * MMPerInch

# telnet connection to terminal server
PROF_HOST = "139.229.101.121"
PROF_PORT = 10001
try:
    TN = Telnet(PROF_HOST, PROF_PORT)
except:
    print("Cannot connect to mitutoyo host!! Manual entry mandatory")
    TN = None


class ParseError(Exception):
    pass

def queryGauges():
    radialFloats = []
    for gaugeNum in range(1,6):
        TN.write("D0%i\r\n"%gaugeNum)
        gaugeOutput = TN.read_until("\r", 1)
        try:
            gauge, val = gaugeOutput.strip().split(":")
            gauge = int(gauge)
            val = float(val)
            assert gauge == gaugeNum
            print("gauge %i: %.4f"%(gauge, val))
        except:
            raise ParseError("Failed to parse gauge %i output: %s"%(gaugeNum, gaugeOutput))
        radialFloats.append(val)
    return radialFloats


def parseRadialMeas(rawInputLine):
    try:
        rawInputLine = rawInputLine.strip()
        measStrs = rawInputLine.split()
        assert len(measStrs)==5
        measStrs = ["."+strMeas for strMeas in measStrs]
        # convert to floats
        radialFloats = [float(meas) for meas in measStrs]
    except:
        raise ParseError("Could not parse: %s"%rawInputLine)
    return radialFloats


def profile(args):
    if not args.plateID:
        plateID = int(raw_input("plateID: "))
    else:
        plateID = int(args.plateID)
    print("Press 'r' key to automatically record gauge values")
    print("---OR---")
    print("Enter radial meaurements space separated with no decimal point.")
    print("Record from plate center to plate edge.")
    print("Begin with North ==> probes towards tab.")
    cardinalMeasurementList = []
    cardinalDirections = DirThetaMapCard.keys() # cardinal directions
    for measDir in cardinalDirections:
        while True:
            try:
                userInput = raw_input("%s: "%measDir)
                userInput = userInput.strip().lower()
                if userInput == "r":
                    # query for values
                    radialFloats = queryGauges()
                else:
                    radialFloats = parseRadialMeas(userInput)
                cardinalMeasurementList.append(CardinalMeasurement(measDir, radialFloats))
            except ParseError as e:
                print(e)
            else:
                break

    doNewInterp(cardinalMeasurementList, MeasRadii)
    plt.show(block=False)
    while True:
        user_input = raw_input("Accept Profile (add to platedb)? [(y)es,(n)o]").strip().lower()
        if user_input in ["yes", "y"]:
            print("Saving profile data to platedb")
            break
        elif user_input in ["no", "n"]:
            print("NOT saving profile to platedb, exiting...")
            sys.exit()
        else:
            print("bad user input. try again.")
    mjd, fscanID = addProfilometry(plateID, cardinalMeasurementList)
    # save image in /data
    print("saving profile image for mjd: %i fscanId: %i plateId: %i"%(mjd, fscanID, plateID))
    basePath = "/data/mapper/%s"%mjd
    baseFile = "profile-%i-%i-%s"%(plateID, mjd, ("%i"%fscanID).zfill(2))
    # any files exist?
    existingFiles = glob.glob(os.path.join(basePath, baseFile+"*.png"))
    nFiles = len(existingFiles)
    profNum = nFiles + 1
    filename = os.path.join(basePath, baseFile+"-%s.png"%(("%i"%profNum).zfill(2)))
    plt.savefig(filename)




def main(argv=None):
    parser = argparse.ArgumentParser(
        prog=os.path.basename(sys.argv[0]),
        formatter_class=argparse.ArgumentDefaultsHelpFormatter,
        description="Profile a plate."
        )
    parser.add_argument("--plateID", type=int, required=False, help="Cart ID")
    args = parser.parse_args()
    profile(args)

if __name__ == '__main__':
    main()

